@page "/events/{Id:int}"
@inject AppDbContext Db
@inject IBookingService BookingService

<PageTitle>@(currentEvent?.Name ?? "Event")</PageTitle>

@if (currentEvent is null)
{
    <div class="text-center"><div class="spinner-border" role="status"></div></div>
}
else
{
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/events">Events</a></li>
            <li class="breadcrumb-item active">@currentEvent.Name</li>
        </ol>
    </nav>

    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">@currentEvent.Name</h2>
        </div>
        <div class="card-body">
            <p class="lead">@currentEvent.Description</p>
            <p><strong>üìÖ Datum:</strong> @currentEvent.Date.ToString("dd MMMM yyyy ‚Äì HH:mm")</p>
            <p><strong>üìç Plats:</strong> @currentEvent.Venue.Name, @currentEvent.Venue.Address, @currentEvent.Venue.City</p>
            <p><strong>üë• Kapacitet:</strong> @currentEvent.Venue.Capacity platser</p>
        </div>
    </div>

    <h3 class="mb-3">Biljetter</h3>
    @if (!currentEvent.Tickets.Any())
    {
        <div class="alert alert-warning">Inga biljetter tillg√§ngliga.</div>
    }
    else
    {
        <div class="row mb-4">
            @foreach (var ticket in currentEvent.Tickets)
            {
                <div class="col-md-4 mb-3">
                    <div class="card @(selectedTicketId == ticket.Id ? "border-primary border-3" : "") h-100">
                        <div class="card-body">
                            <h5 class="card-title">@ticket.TicketType</h5>
                            <p class="display-6 text-primary">@ticket.Price kr</p>
                            <p>
                                <span class="badge @(ticket.QuantityAvailable > 0 ? "bg-success" : "bg-danger")">
                                    @ticket.QuantityAvailable / @ticket.QuantityTotal tillg√§ngliga
                                </span>
                            </p>
                        </div>
                        <div class="card-footer">
                            <button class="btn @(selectedTicketId == ticket.Id ? "btn-primary" : "btn-outline-primary") w-100"
                                    disabled="@(ticket.QuantityAvailable == 0)"
                                    @onclick="() => SelectTicket(ticket.Id)">
                                @(selectedTicketId == ticket.Id ? "‚úì Vald" : "V√§lj")
                            </button>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (selectedTicketId.HasValue)
        {
            var selectedTicket = currentEvent.Tickets.First(t => t.Id == selectedTicketId.Value);
            <div class="card shadow-sm">
                <div class="card-header"><h4 class="mb-0">Bokningsformul√§r ‚Äì @selectedTicket.TicketType</h4></div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success">@successMessage</div>
                    }
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }

                    <EditForm Model="bookingForm" OnValidSubmit="SubmitBooking">
                        <DataAnnotationsValidator />
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Namn</label>
                                <InputText class="form-control" @bind-Value="bookingForm.CustomerName" placeholder="Ditt namn" />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">E-post</label>
                                <InputText class="form-control" @bind-Value="bookingForm.CustomerEmail" placeholder="din@email.com" />
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Antal biljetter</label>
                            <InputNumber class="form-control" @bind-Value="bookingForm.Quantity" min="1" max="@selectedTicket.QuantityAvailable" />
                            <div class="form-text">
                                Max @selectedTicket.QuantityAvailable st. Totalt: <strong>@(bookingForm.Quantity * selectedTicket.Price) kr</strong>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" disabled="@isSubmitting">
                            @(isSubmitting ? "Bokar..." : "Boka nu")
                        </button>
                    </EditForm>
                </div>
            </div>
        }
    }

    <h3 class="mt-5 mb-3">Bokningar f√∂r detta event</h3>
    @if (bookings is null || !bookings.Any())
    {
        <div class="alert alert-secondary">Inga bokningar √§n.</div>
    }
    else
    {
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>#</th>
                    <th>Kund</th>
                    <th>Biljetttyp</th>
                    <th>Antal</th>
                    <th>Totalt</th>
                    <th>Status</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var b in bookings)
                {
                    <tr class="@(b.IsCancelled ? "table-secondary text-muted" : "")">
                        <td>@b.Id</td>
                        <td>
                            <strong>@b.CustomerName</strong><br />
                            <small>@b.CustomerEmail</small>
                        </td>
                        <td>@b.Ticket.TicketType</td>
                        <td>@b.Quantity</td>
                        <td>@b.TotalPrice kr</td>
                        <td>
                            @if (b.IsCancelled)
                            {
                                <span class="badge bg-danger">Avbokad</span>
                            }
                            else
                            {
                                <span class="badge bg-success">Aktiv</span>
                            }
                        </td>
                        <td>
                            @if (!b.IsCancelled)
                            {
                                <button class="btn btn-sm btn-outline-danger"
                                        @onclick="() => CancelBooking(b.Id)">
                                    Avboka
                                </button>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    [Parameter] public int Id { get; set; }

    private Event? currentEvent;
    private List<Booking>? bookings;

    private int? selectedTicketId;
    private BookingFormModel bookingForm = new();
    private bool isSubmitting = false;
    private string? successMessage;
    private string? errorMessage;

    protected override async Task OnInitializedAsync() => await Reload();

    private async Task Reload()
    {
        currentEvent = await Db.Events
            .Include(e => e.Venue)
            .Include(e => e.Tickets)
            .FirstOrDefaultAsync(e => e.Id == Id);

        bookings = await Db.Bookings
            .Include(b => b.Ticket)
            .Where(b => b.Ticket.EventId == Id)
            .OrderByDescending(b => b.BookingDate)
            .ToListAsync();
    }

    private void SelectTicket(int ticketId)
    {
        selectedTicketId = ticketId;
        bookingForm = new();
        bookingForm.Quantity = 1;
        successMessage = null;
        errorMessage = null;
    }

    private async Task SubmitBooking()
    {
        if (!selectedTicketId.HasValue) return;

        isSubmitting = true;
        successMessage = null;
        errorMessage = null;

        try
        {
            var dto = new EventBokningApp.DTOs.CreateBookingDto(
                selectedTicketId.Value,
                bookingForm.CustomerName,
                bookingForm.CustomerEmail,
                bookingForm.Quantity
            );
            await BookingService.CreateBookingAsync(dto);
            successMessage = $"Bokning klar! {bookingForm.Quantity} biljett(er) bokade f√∂r {bookingForm.CustomerName}.";
            bookingForm = new() { Quantity = 1 };
            selectedTicketId = null;

            // Refresh data
            Db.ChangeTracker.Clear();
            await Reload();
        }
        catch (BusinessException ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task CancelBooking(int bookingId)
    {
        try
        {
            await BookingService.CancelBookingAsync(bookingId);
            Db.ChangeTracker.Clear();
            await Reload();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private class BookingFormModel
    {
        public string CustomerName { get; set; } = string.Empty;
        public string CustomerEmail { get; set; } = string.Empty;
        public int Quantity { get; set; } = 1;
    }
}
