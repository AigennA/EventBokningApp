@page "/events/{Id:int}"
@inject AppDbContext Db
@inject IBookingService BookingService
@inject BlazorAuthService BlazorAuth
@inject NavigationManager Nav

<PageTitle>@(currentEvent?.Name ?? "Event") ‚Äì Bokningssystem</PageTitle>

@if (currentEvent is null)
{
    <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <p>H√§mtar event...</p>
    </div>
}
else
{
    <!-- Breadcrumb -->
    <nav class="breadcrumb-nav">
        <a href="/events" class="breadcrumb-link">Events</a>
        <span class="breadcrumb-sep">‚Ä∫</span>
        <span class="breadcrumb-current">@currentEvent.Name</span>
    </nav>

    <!-- Event Hero -->
    <div class="event-detail-hero">
        <div class="event-detail-info">
            <div class="event-detail-date">
                <span class="detail-date-day">@currentEvent.Date.ToString("dd")</span>
                <span class="detail-date-month">@currentEvent.Date.ToString("MMMM yyyy")</span>
                <span class="detail-date-time">@currentEvent.Date.ToString("HH:mm")</span>
            </div>
            <div class="event-detail-text">
                <h1 class="event-detail-title">@currentEvent.Name</h1>
                <p class="event-detail-desc">@currentEvent.Description</p>
                <div class="event-detail-meta">
                    <span class="meta-pill">üìç @currentEvent.Venue.Name, @currentEvent.Venue.City</span>
                    <span class="meta-pill">üë• @currentEvent.Venue.Capacity platser</span>
                    <span class="meta-pill">üìã @currentEvent.Tickets.Count biljetttyper</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tickets Section -->
    <section class="tickets-section">
        <h2 class="section-title">V√§lj Biljett</h2>

        @if (!currentEvent.Tickets.Any())
        {
            <div class="empty-state"><p>Inga biljetter tillg√§ngliga f√∂r detta event.</p></div>
        }
        else
        {
            <div class="tickets-grid">
                @foreach (var ticket in currentEvent.Tickets)
                {
                    var isSelected = selectedTicketId == ticket.Id;
                    var isAvailable = ticket.QuantityAvailable > 0;
                    <div class="ticket-card @(isSelected ? "ticket-selected" : "") @(!isAvailable ? "ticket-sold-out" : "")">
                        <div class="ticket-card-top">
                            <span class="ticket-type-name">@ticket.TicketType</span>
                            @if (!isAvailable)
                            {
                                <span class="sold-out-tag">Sluts√•ld</span>
                            }
                        </div>
                        <div class="ticket-price">
                            <span class="price-big">@ticket.Price.ToString("N0")</span>
                            <span class="price-currency">kr</span>
                        </div>
                        <div class="ticket-availability">
                            <div class="avail-bar-bg">
                                <div class="avail-bar-fill" style="width: @(ticket.QuantityTotal > 0 ? (ticket.QuantityAvailable * 100 / ticket.QuantityTotal) : 0)%"></div>
                            </div>
                            <span class="avail-text">@ticket.QuantityAvailable / @ticket.QuantityTotal tillg√§ngliga</span>
                        </div>
                        <button class="btn-select-ticket @(isSelected ? "btn-selected" : "")"
                                disabled="@(!isAvailable)"
                                @onclick="() => SelectTicket(ticket.Id)">
                            @(isSelected ? "‚úì Vald" : "V√§lj")
                        </button>
                    </div>
                }
            </div>

            @if (selectedTicketId.HasValue)
            {
                var selectedTicket = currentEvent.Tickets.First(t => t.Id == selectedTicketId.Value);
                <div class="booking-form-card">
                    <div class="booking-form-header">
                        <h3>Bokningsformul√§r</h3>
                        <span class="selected-ticket-tag">@selectedTicket.TicketType</span>
                    </div>
                    <div class="booking-form-body">
                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert-success">‚úÖ @successMessage</div>
                        }
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert-error">‚ö†Ô∏è @errorMessage</div>
                        }

                        @if (!BlazorAuth.IsAuthenticated)
                        {
                            <div class="auth-required-box">
                                <p>Du m√•ste vara inloggad f√∂r att boka biljetter.</p>
                                <a href="/login" class="btn-primary-pill">Logga in f√∂r att boka</a>
                            </div>
                        }
                        else
                        {
                            <EditForm Model="bookingForm" OnValidSubmit="SubmitBooking">
                                <DataAnnotationsValidator />
                                <div class="form-grid-2">
                                    <div class="form-group">
                                        <label class="form-label">Namn</label>
                                        <InputText class="form-input" @bind-Value="bookingForm.CustomerName" placeholder="Ditt namn" />
                                        <ValidationMessage For="@(() => bookingForm.CustomerName)" class="validation-msg" />
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">E-post</label>
                                        <InputText class="form-input" @bind-Value="bookingForm.CustomerEmail" placeholder="din@email.com" />
                                        <ValidationMessage For="@(() => bookingForm.CustomerEmail)" class="validation-msg" />
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Antal biljetter</label>
                                    <div class="quantity-selector">
                                        <button type="button" class="qty-btn" @onclick="() => bookingForm.Quantity = Math.Max(1, bookingForm.Quantity - 1)">‚àí</button>
                                        <InputNumber class="form-input qty-input" @bind-Value="bookingForm.Quantity" min="1" max="@selectedTicket.QuantityAvailable" />
                                        <button type="button" class="qty-btn" @onclick="() => bookingForm.Quantity = Math.Min(selectedTicket.QuantityAvailable, bookingForm.Quantity + 1)">+</button>
                                    </div>
                                    <div class="total-price-display">
                                        Totalt: <span class="total-price-amount">@((bookingForm.Quantity * selectedTicket.Price).ToString("N0")) kr</span>
                                    </div>
                                </div>
                                <button type="submit" class="btn-book-submit" disabled="@isSubmitting">
                                    @(isSubmitting ? "Bokar..." : "‚úì Boka nu")
                                </button>
                            </EditForm>
                        }
                    </div>
                </div>
            }
        }
    </section>

    <!-- Bookings Table -->
    <section class="section-container">
        <h2 class="section-title">Bokningar f√∂r detta event</h2>
        @if (bookings is null || !bookings.Any())
        {
            <div class="empty-state"><p>Inga bokningar registrerade √§n.</p></div>
        }
        else
        {
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Kund</th>
                            <th>Biljetttyp</th>
                            <th>Antal</th>
                            <th>Totalt</th>
                            <th>Status</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var b in bookings)
                        {
                            <tr class="@(b.IsCancelled ? "row-cancelled" : "")">
                                <td class="text-muted">@b.Id</td>
                                <td>
                                    <div class="fw-bold">@b.CustomerName</div>
                                    <div class="text-muted text-sm">@b.CustomerEmail</div>
                                </td>
                                <td>@b.Ticket.TicketType</td>
                                <td>@b.Quantity</td>
                                <td class="text-green fw-bold">@b.TotalPrice.ToString("N0") kr</td>
                                <td><BookingStatusBadge IsCancelled="@b.IsCancelled" /></td>
                                <td>
                                    @if (!b.IsCancelled)
                                    {
                                        <button class="btn-danger-outline" @onclick="() => CancelBooking(b.Id)">
                                            Avboka
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </section>
}

@code {
    [Parameter] public int Id { get; set; }

    private Models.Event? currentEvent;
    private List<Models.Booking>? bookings;
    private int? selectedTicketId;
    private BookingFormModel bookingForm = new();
    private bool isSubmitting;
    private string? successMessage;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (BlazorAuth.Email is not null)
            bookingForm.CustomerEmail = BlazorAuth.Email;
        if (BlazorAuth.Username is not null)
            bookingForm.CustomerName = BlazorAuth.Username;
        await Reload();
    }

    private async Task Reload()
    {
        currentEvent = await Db.Events
            .Include(e => e.Venue)
            .Include(e => e.Tickets)
            .FirstOrDefaultAsync(e => e.Id == Id);

        bookings = await Db.Bookings
            .Include(b => b.Ticket)
            .Where(b => b.Ticket.EventId == Id)
            .OrderByDescending(b => b.BookingDate)
            .ToListAsync();
    }

    private void SelectTicket(int ticketId)
    {
        selectedTicketId = selectedTicketId == ticketId ? null : ticketId;
        successMessage = errorMessage = null;
    }

    private async Task SubmitBooking()
    {
        if (!selectedTicketId.HasValue || !BlazorAuth.IsAuthenticated) return;
        isSubmitting = true;
        successMessage = errorMessage = null;
        try
        {
            var dto = new DTOs.CreateBookingDto(
                selectedTicketId.Value,
                bookingForm.CustomerName,
                bookingForm.CustomerEmail,
                bookingForm.Quantity);
            await BookingService.CreateBookingAsync(dto);
            successMessage = $"Bokning klar! {bookingForm.Quantity} biljett(er) bokade.";
            bookingForm = new() { Quantity = 1, CustomerEmail = BlazorAuth.Email ?? "", CustomerName = BlazorAuth.Username ?? "" };
            selectedTicketId = null;
            Db.ChangeTracker.Clear();
            await Reload();
        }
        catch (Exceptions.BusinessException ex) { errorMessage = ex.Message; }
        finally { isSubmitting = false; }
    }

    private async Task CancelBooking(int bookingId)
    {
        try
        {
            await BookingService.CancelBookingAsync(bookingId);
            Db.ChangeTracker.Clear();
            await Reload();
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private class BookingFormModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Namn kr√§vs")]
        public string CustomerName { get; set; } = string.Empty;
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "E-post kr√§vs")]
        [System.ComponentModel.DataAnnotations.EmailAddress(ErrorMessage = "Ogiltig e-post")]
        public string CustomerEmail { get; set; } = string.Empty;
        [System.ComponentModel.DataAnnotations.Range(1, 100, ErrorMessage = "Minst 1 biljett")]
        public int Quantity { get; set; } = 1;
    }
}
